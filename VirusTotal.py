import requests, time, json, os

# 바이러스토탈 API Key
my_apikey = 'virustotal_api_key'

# 바이러스 의심 파일 설정
path_dir = './exploit/bazaar_abuse'
for (root, directories, files) in os.walk(path_dir):
    for i in files:
        file = path_dir+"/"+i
        filepath = file.split(".")
        if filepath[1] == "json":
            continue
        files = {'file': (file, open(file, 'rb'))}

        # 바이러스토탈 파일 스캔 주소
        url_scan = 'https://www.virustotal.com/vtapi/v2/file/scan'
        url_scan_params = {'apikey': my_apikey}

        # 바이러스토탈 파일 스캔 시작
        response_scan = requests.post(url_scan, files=files, params=url_scan_params)
        result_scan = response_scan.json()
        scan_resource = result_scan['resource']

        # URL 스캔 시작 안내
        print('Virustotal FILE SCAN START (15 Seconds Later) : ', file, '\n')

        # URL 스캔 후 20초 대기 : 결과가 바로 나오지 않기 때문에 16초 정도 대기(1분에 최대 4개씩 밖에 못 돌리기도함)
        time.sleep(20)

        # 바이러스토탈 파일 스캔 결과 주소
        url_report = 'https://www.virustotal.com/vtapi/v2/file/report'
        url_report_params = {'apikey': my_apikey, 'resource': scan_resource}

        # 바이러스토탈 파일 스캔 결과 리포트 조회
        response_report = requests.get(url_report, params=url_report_params)

        # 점검 결과 데이터 추출
        report = response_report.json()

        #json 파일 저장
        filename = i.split(".")
        savepath = "./exploit/report/"+ filename[0] + "_report.json"
        print(savepath)
        with open(savepath, 'w') as f:
            json.dump(report, f)

        print("Done!")
